<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doppelpuffer DMA ‚Üî Ethernet Animation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        #startBtn {
            background: #4CAF50;
            color: white;
        }
        
        #pauseBtn {
            background: #FF9800;
            color: white;
        }
        
        #resetBtn {
            background: #f44336;
            color: white;
        }
        
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .speed-control label {
            font-weight: bold;
        }
        
        #speedSlider {
            width: 150px;
        }
        
        .speed-settings {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #1976D2;
        }
        
        .speed-settings h3 {
            margin-top: 0;
            color: #1976D2;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .speed-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .speed-input-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .speed-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .speed-input-row label {
            font-weight: bold;
            min-width: 140px;
        }
        
        .speed-input-row input[type="range"] {
            flex: 1;
            min-width: 120px;
        }
        
        .speed-input-row input[type="number"] {
            width: 70px;
            padding: 5px;
            border: 2px solid #1976D2;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        
        .speed-value {
            font-weight: bold;
            color: #1976D2;
            min-width: 60px;
        }
        
        .scenario-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .scenario-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: 2px solid #1976D2;
            background: white;
            color: #1976D2;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .scenario-btn:hover {
            background: #1976D2;
            color: white;
        }
        
        .canvas-container {
            border: 2px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: auto;
        }
        
        .state-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .state-info h3 {
            margin-top: 0;
            color: #333;
        }
        
        .state-description {
            font-size: 16px;
            line-height: 1.6;
            color: #555;
        }
        
        .warning {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        .warning-text {
            color: #c62828;
            font-weight: bold;
        }
        
        .legend {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #fafafa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 5px;
            border: 2px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Doppelpuffer DMA ‚Üî Ethernet Animation</h1>
        
        <div class="controls">
            <button id="startBtn">‚ñ∂ Start</button>
            <button id="pauseBtn">‚è∏ Pause</button>
            <button id="resetBtn">üîÑ Zur√ºcksetzen</button>
            <div class="speed-control">
                <label for="speedSlider">Animationsgeschw.:</label>
                <input type="range" id="speedSlider" min="1" max="10" value="5">
                <span id="speedValue">5x</span>
            </div>
        </div>
        
        <div class="speed-settings">
            <h3>‚öôÔ∏è Geschwindigkeitseinstellungen</h3>
            <div class="speed-inputs">
                <div class="speed-input-group">
                    <div class="speed-input-row">
                        <label for="dmaSpeed">DMA Geschw.:</label>
                        <input type="range" id="dmaSpeedSlider" min="1" max="15" step="0.5" value="10">
                        <input type="number" id="dmaSpeedInput" min="1" max="15" step="0.5" value="10.0">
                        <span class="speed-value">%/s</span>
                    </div>
                </div>
                <div class="speed-input-group">
                    <div class="speed-input-row">
                        <label for="ethSpeed">Ethernet Geschw.:</label>
                        <input type="range" id="ethSpeedSlider" min="1" max="15" step="0.5" value="10">
                        <input type="number" id="ethSpeedInput" min="1" max="15" step="0.5" value="10.0">
                        <span class="speed-value">%/s</span>
                    </div>
                </div>
            </div>
            <div class="scenario-buttons">
                <button class="scenario-btn" onclick="setScenario('ideal')"> Ideal (Ausgeglichen)</button>
                <button class="scenario-btn" onclick="setScenario('real')">‚úÖ Real Case (ETH langsamer)</button>
                <button class="scenario-btn" onclick="setScenario('future')">üöÄ Zukunft (ETH schneller)</button>
            </div>
        </div>
        
        <div class="canvas-container">
            <canvas id="canvas" width="850" height="500"></canvas>
        </div>
        
        <div class="state-info">
            <h3>Aktueller Zustand: <span id="stateName">Start</span></h3>
            <div class="state-description" id="stateDescription">
                System ist bereit. Klicken Sie auf "Start" um die Animation zu beginnen.
            </div>
            <div id="warningBox" class="warning" style="display: none;">
                <div class="warning-text">‚ö† WARNUNG: DMA MUSS WARTEN!</div>
                <div>Beide Puffer sind voll. Ethernet sendet zu langsam.</div>
            </div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #CCCCCC;"></div>
                <span>Leer</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #FFD54F;"></div>
                <span>Wird gef√ºllt</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #66BB6A;"></div>
                <span>Voll</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #42A5F5;"></div>
                <span>Wird gesendet</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #EF5350;"></div>
                <span>Blockiert</span>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        
        let animationId;
        let isRunning = false;
        let speed = 5;
        
        // Zustand des Systems
        let state = 0; // 0: Start, 1: DMA->A, 2: DMA->B ETH->A, 3: DMA->A ETH->B, 4: Warten
        let bufferA = 0; // 0-100 F√ºllstand
        let bufferB = 0;
        let ethProgress = 0;
        let dmaSpeed = 10;
        let ethSpeed = 10; // Ausgeglichen - DMA und ETH gleich schnell
        let time = 0;
        
        const stateDescriptions = {
            0: "System startet. DMA beginnt Puffer A zu f√ºllen.",
            1: "DMA schreibt in Puffer A. Ethernet wartet.",
            2: "DMA schreibt in Puffer B. Ethernet sendet Puffer A gleichzeitig.",
            3: "DMA schreibt in Puffer A. Ethernet sendet Puffer B gleichzeitig.",
            4: "‚ö† Beide Puffer sind voll! DMA muss warten bis Ethernet fertig ist.",
            5: "DMA f√ºllt Puffer B. Ethernet wartet bis B voll ist.",
            6: "DMA f√ºllt Puffer A. Ethernet wartet bis A voll ist."
        };
        
        const stateNames = {
            0: "Start",
            1: "Zustand 1: DMA ‚Üí A (ETH wartet)",
            2: "Zustand 2: DMA ‚Üí B, ETH ‚Üí A",
            3: "Zustand 3: DMA ‚Üí A, ETH ‚Üí B",
            4: "Zustand 4: DMA wartet (Blockierung)",
            5: "DMA ‚Üí B (ETH wartet auf vollen B)",
            6: "DMA ‚Üí A (ETH wartet auf vollen A)"
        };
        
        function updateStateInfo() {
            document.getElementById('stateName').textContent = stateNames[state];
            document.getElementById('stateDescription').textContent = stateDescriptions[state];
            document.getElementById('warningBox').style.display = state === 4 ? 'block' : 'none';
        }
        
        function drawBuffer(x, y, width, height, fill, label, subtext) {
            // Rahmen
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 3;
            ctx.fillStyle = '#f5f5f5';
            ctx.fillRect(x, y, width, height);
            ctx.strokeRect(x, y, width, height);
            
            // F√ºllstand
            if (fill > 0) {
                const fillHeight = (fill / 100) * height;
                const gradient = ctx.createLinearGradient(x, y + height - fillHeight, x, y + height);
                gradient.addColorStop(0, getColorForFill(fill, subtext));
                gradient.addColorStop(1, adjustColor(getColorForFill(fill, subtext), -20));
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y + height - fillHeight, width, fillHeight);
            }
            
            // Label
            ctx.fillStyle = '#333';
            ctx.font = 'bold 20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(label, x + width/2, y - 30);
            
            // Subtext
            ctx.font = '14px Arial';
            ctx.fillText(subtext, x + width/2, y - 10);
            
            // Prozentanzeige
            ctx.font = 'bold 24px Arial';
            ctx.fillStyle = fill > 50 ? 'white' : '#333';
            ctx.fillText(Math.round(fill) + '%', x + width/2, y + height/2 + 8);
        }
        
        function getColorForFill(fill, status) {
            if (status.includes('Blockiert')) return '#EF5350';
            if (status.includes('sendet')) return '#42A5F5';
            if (fill >= 100) return '#66BB6A';
            if (fill > 0) return '#FFD54F';
            return '#CCCCCC';
        }
        
        function adjustColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }
        
        function drawComponent(x, y, width, height, label, active) {
            ctx.fillStyle = active ? '#4CAF50' : '#9E9E9E';
            ctx.fillRect(x, y, width, height);
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, width, height);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 16px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(label, x + width/2, y + height/2 + 5);
        }
        
        function drawArrow(fromX, fromY, toX, toY, label, active) {
            ctx.strokeStyle = active ? '#4CAF50' : '#CCCCCC';
            ctx.lineWidth = active ? 4 : 2;
            ctx.setLineDash(active ? [] : [5, 5]);
            
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();
            
            // Pfeilspitze
            const angle = Math.atan2(toY - fromY, toX - fromX);
            ctx.beginPath();
            ctx.moveTo(toX, toY);
            ctx.lineTo(toX - 15 * Math.cos(angle - Math.PI/6), toY - 15 * Math.sin(angle - Math.PI/6));
            ctx.lineTo(toX - 15 * Math.cos(angle + Math.PI/6), toY - 15 * Math.sin(angle + Math.PI/6));
            ctx.closePath();
            ctx.fillStyle = ctx.strokeStyle;
            ctx.fill();
            
            ctx.setLineDash([]);
            
            // Label
            if (label && active) {
                const midX = (fromX + toX) / 2;
                const midY = (fromY + toY) / 2;
                ctx.fillStyle = '#333';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(label, midX, midY - 5);
            }
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Titel
            ctx.fillStyle = '#333';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Doppelpuffer DMA ‚Üî Ethernet System', canvas.width/2, 30);
            
            // DMA Controller
            drawComponent(50, 200, 120, 80, 'DMA', state !== 4);
            
            // Puffer A
            let bufferAStatus = 'Leer';
            if (state === 1 || state === 6 || (state === 3 && bufferA < 100)) bufferAStatus = 'Wird gef√ºllt';
            else if (state === 2 || (state === 4 && bufferA > 0 && bufferB >= 100)) bufferAStatus = 'ETH sendet';
            else if (bufferA >= 100) bufferAStatus = state === 4 ? 'Voll/Blockiert' : 'Voll';
            drawBuffer(250, 100, 150, 120, bufferA, 'Puffer A', bufferAStatus);
            
            // Puffer B
            let bufferBStatus = 'Leer';
            if (state === 5 || (state === 2 && bufferB < 100)) bufferBStatus = 'Wird gef√ºllt';
            else if (state === 3 || (state === 4 && bufferB > 0 && bufferA >= 100)) bufferBStatus = 'ETH sendet';
            else if (bufferB >= 100) bufferBStatus = state === 4 ? 'Voll/Blockiert' : 'Voll';
            drawBuffer(250, 280, 150, 120, bufferB, 'Puffer B', bufferBStatus);
            
            // Ethernet Interface
            const ethActive = state === 2 || state === 3 || state === 4;
            drawComponent(500, 200, 120, 80, 'Ethernet', ethActive);
            
            // Pfeile
            // DMA -> Puffer A
            drawArrow(170, 220, 245, 160, 'Schreiben', state === 1 || state === 3 || state === 6);
            
            // DMA -> Puffer B
            drawArrow(170, 260, 245, 340, 'Schreiben', state === 2 || state === 5);
            
            // Puffer A -> Ethernet (aktiv in state 2 und wenn A entleert wird in state 4)
            const ethSendingA = state === 2 || (state === 4 && bufferA > 0 && bufferB >= 100);
            drawArrow(405, 160, 495, 220, 'Senden', ethSendingA);
            
            // Puffer B -> Ethernet (aktiv in state 3 und wenn B entleert wird in state 4)
            const ethSendingB = state === 3 || (state === 4 && bufferB > 0 && bufferA >= 100);
            drawArrow(405, 340, 495, 260, 'Senden', ethSendingB);
            
            // Status Text
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText('Zeit: ' + (time/60).toFixed(1) + 's', 20, 460);
            ctx.fillText('DMA Geschw.: ' + dmaSpeed.toFixed(1) + '%/s', 20, 480);
            ctx.fillText('ETH Geschw.: ' + ethSpeed.toFixed(1) + '%/s', 200, 480);
        }
        
        function updateSimulation() {
            if (!isRunning) return;
            
            time++;
            
            switch(state) {
                case 0: // Start
                    state = 1;
                    bufferA = 0;
                    bufferB = 0;
                    break;
                    
                case 1: // DMA f√ºllt A, Ethernet wartet
                    bufferA += dmaSpeed * speed * 0.1;
                    if (bufferA >= 100) {
                        bufferA = 100;
                        state = 2; // Wechsel zu Zustand 2: DMA->B, ETH->A
                        ethProgress = 0;
                    }
                    break;
                    
                case 2: // DMA f√ºllt B, ETH sendet A
                    bufferB += dmaSpeed * speed * 0.1;
                    bufferA -= ethSpeed * speed * 0.1;
                    
                    if (bufferB >= 100) {
                        bufferB = 100;
                        // Puffer B ist voll
                        if (bufferA > 0) {
                            // A ist noch nicht fertig gesendet -> Warten
                            state = 4;
                        } else {
                            // A ist leer -> weiter mit DMA->A, ETH->B
                            bufferA = 0;
                            state = 3;
                            ethProgress = 0;
                        }
                    } else if (bufferA <= 0) {
                        // A ist fertig gesendet, aber B noch nicht voll
                        bufferA = 0;
                        // Ethernet muss warten bis B voll ist
                        state = 5; // Neuer Wartezustand: DMA f√ºllt B, ETH wartet
                    }
                    break;
                    
                case 3: // DMA f√ºllt A, ETH sendet B
                    bufferA += dmaSpeed * speed * 0.1;
                    bufferB -= ethSpeed * speed * 0.1;
                    
                    if (bufferA >= 100) {
                        bufferA = 100;
                        // Puffer A ist voll
                        if (bufferB > 0) {
                            // B ist noch nicht fertig gesendet -> Warten
                            state = 4;
                        } else {
                            // B ist leer -> weiter mit DMA->B, ETH->A
                            bufferB = 0;
                            state = 2;
                            ethProgress = 0;
                        }
                    } else if (bufferB <= 0) {
                        // B ist fertig gesendet, aber A noch nicht voll
                        bufferB = 0;
                        // Ethernet muss warten bis A voll ist
                        state = 6; // Neuer Wartezustand: DMA f√ºllt A, ETH wartet
                    }
                    break;
                    
                case 4: // Warten - beide Puffer voll, DMA blockiert
                    // Nur Ethernet arbeitet
                    if (bufferA > 0 && bufferB >= 100) {
                        // ETH sendet A weiter
                        bufferA -= ethSpeed * speed * 0.1;
                        if (bufferA <= 0) {
                            bufferA = 0;
                            state = 3; // Weiter mit DMA->A, ETH->B
                        }
                    } else if (bufferB > 0 && bufferA >= 100) {
                        // ETH sendet B weiter
                        bufferB -= ethSpeed * speed * 0.1;
                        if (bufferB <= 0) {
                            bufferB = 0;
                            state = 2; // Weiter mit DMA->B, ETH->A
                        }
                    }
                    break;
                    
                case 5: // DMA f√ºllt B, ETH wartet auf vollen Puffer B
                    bufferB += dmaSpeed * speed * 0.1;
                    if (bufferB >= 100) {
                        bufferB = 100;
                        state = 3; // Jetzt kann ETH B senden, DMA->A
                        ethProgress = 0;
                    }
                    break;
                    
                case 6: // DMA f√ºllt A, ETH wartet auf vollen Puffer A
                    bufferA += dmaSpeed * speed * 0.1;
                    if (bufferA >= 100) {
                        bufferA = 100;
                        state = 2; // Jetzt kann ETH A senden, DMA->B
                        ethProgress = 0;
                    }
                    break;
            }
            
            // Bounds checking
            bufferA = Math.max(0, Math.min(100, bufferA));
            bufferB = Math.max(0, Math.min(100, bufferB));
            
            updateStateInfo();
            draw();
            
            animationId = requestAnimationFrame(updateSimulation);
        }
        
        document.getElementById('startBtn').addEventListener('click', () => {
            if (!isRunning) {
                isRunning = true;
                updateSimulation();
            }
        });
        
        document.getElementById('pauseBtn').addEventListener('click', () => {
            isRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });
        
        document.getElementById('resetBtn').addEventListener('click', () => {
            isRunning = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            state = 0;
            bufferA = 0;
            bufferB = 0;
            ethProgress = 0;
            time = 0;
            updateStateInfo();
            draw();
        });
        
        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedValue').textContent = speed + 'x';
        });
        
        // DMA Speed Controls
        document.getElementById('dmaSpeedSlider').addEventListener('input', (e) => {
            dmaSpeed = parseFloat(e.target.value);
            document.getElementById('dmaSpeedInput').value = dmaSpeed.toFixed(1);
        });
        
        document.getElementById('dmaSpeedInput').addEventListener('input', (e) => {
            let value = parseFloat(e.target.value);
            if (value < 1) value = 1;
            if (value > 15) value = 15;
            dmaSpeed = value;
            document.getElementById('dmaSpeedSlider').value = value;
            e.target.value = value.toFixed(1);
        });
        
        // Ethernet Speed Controls
        document.getElementById('ethSpeedSlider').addEventListener('input', (e) => {
            ethSpeed = parseFloat(e.target.value);
            document.getElementById('ethSpeedInput').value = ethSpeed.toFixed(1);
        });
        
        document.getElementById('ethSpeedInput').addEventListener('input', (e) => {
            let value = parseFloat(e.target.value);
            if (value < 1) value = 1;
            if (value > 15) value = 15;
            ethSpeed = value;
            document.getElementById('ethSpeedSlider').value = value;
            e.target.value = value.toFixed(1);
        });
        
        // Scenario presets
        function setScenario(scenario) {
            switch(scenario) {
                case 'ideal':
                    // Ideal: Ausgeglichen - DMA und ETH gleich schnell
                    dmaSpeed = 7;
                    ethSpeed = 7;
                    break;
                case 'real':
                    // Real Case: ETH langsamer als DMA
                    dmaSpeed = 7;
                    ethSpeed = 1;
                    break;
                case 'future':
                    // Zukunft: ETH schneller als DMA
                    dmaSpeed = 1;
                    ethSpeed = 7;
                    break;
            }
            
            // Update UI
            document.getElementById('dmaSpeedSlider').value = dmaSpeed;
            document.getElementById('dmaSpeedInput').value = dmaSpeed.toFixed(1);
            document.getElementById('ethSpeedSlider').value = ethSpeed;
            document.getElementById('ethSpeedInput').value = ethSpeed.toFixed(1);
            
            // Reset animation to see effect
            const wasRunning = isRunning;
            isRunning = false;
            if (animationId) cancelAnimationFrame(animationId);
            state = 0;
            bufferA = 0;
            bufferB = 0;
            ethProgress = 0;
            time = 0;
            updateStateInfo();
            draw();
            
            if (wasRunning) {
                isRunning = true;
                updateSimulation();
            }
        }
        
        // Make setScenario globally available
        window.setScenario = setScenario;
        
        // Initial draw
        updateStateInfo();
        draw();
    </script>
</body>
</html>
